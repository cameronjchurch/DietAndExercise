@page "/"

@using DietAndExercise.Models
@using System.Collections.ObjectModel

@inject DietAndExercise.Services.IDietAndExerciseService DietAndExerciseService

@rendermode @(new InteractiveServerRenderMode(prerender: false))

@layout AlternateLayout

<PageTitle>Home</PageTitle>

@if (dayRecords == null || !System.Linq.Enumerable.Any(dayRecords))
{
    <p>No records found.</p>
}
else
{
    <BitStack Alignment="BitAlignment.Center" Horizontal="true">
        <div>Max: @max</div><div>Min: @min</div><div>Avg: @average</div>
    </BitStack>
    <BitChart Config="_config" @ref="_chart" />

    <div class="record-list" style="display:flex;flex-direction:column;align-items:center;padding:1rem;">
        <label for="recordSelect" style="font-weight:600;margin-bottom:0.25rem;">Select Date</label>
        <select id="recordSelect" @bind="selectedDay" style="padding:0.5rem;margin-bottom:1rem;min-width:300px;">
            <option value="">-- Select a date --</option>
            @foreach (var record in dayRecords)
            {
                <option value="@record.Date.ToString()">@record.Date</option>
            }
        </select>

        @if (SelectedRecord == null)
        {
            <p>No record selected.</p>
        }
        else
        {
            <BitCard class="responsive-card">
                <div style="padding:1rem;word-break:break-word;overflow-wrap:break-word;hyphens:auto;">
                    <div style="margin-bottom:0.5rem;">
                        <strong>Date</strong>
                        <span>: @SelectedRecord.Date</span>
                    </div>
                    <div style="margin-bottom:0.5rem;">
                        <strong>WeightLb</strong>
                        <span>: @SelectedRecord.WeightLb</span>
                    </div>
                    <div style="margin-bottom:0.5rem;">
                        <strong>Food</strong>
                        <span>: @SelectedRecord.FoodIntakeNotes</span>
                    </div>
                    <div style="margin-bottom:0.5rem;">
                        <strong>Exercise</strong>
                        <span>: @SelectedRecord.ExerciseNotes</span>
                    </div>
                </div>
            </BitCard>
        }
    </div>
}

<style>
    /* Default desktop/regular browser size */
    .responsive-card {
        width: 750px;
        min-width: 750px;
        max-width: 750px;
        margin: 0 auto 1rem;
        box-sizing: border-box;
    }

    @@media only screen and (max-width: 600px) {
        .responsive-card {
            width: 400px;
            min-width: 400px;
            max-width: 400px;
            margin: 0 auto 1rem;
            box-sizing: border-box;
        }
    }
</style>

@code {
    IEnumerable<DayRecord> dayRecords = System.Array.Empty<DayRecord>();
    double max;
    double min;
    double average;
    private BitChart _chart = default!;
    private BitChartLineConfig _config = default!;
    string selectedDay = string.Empty;

    protected override void OnInitialized()
    {
        dayRecords = DietAndExerciseService.GetHistory();
        if (dayRecords == null || !dayRecords.Any())
        {
            return;
        }

        max = dayRecords.Max(dr => dr.WeightLb);
        min = dayRecords.Min(dr => dr.WeightLb);
        average = Math.Round(dayRecords.Average(dr => dr.WeightLb), 1);

        var days = dayRecords.Select(d => d.Date.ToString());
        var weights = dayRecords.Select(d => d.WeightLb);

        InitializeChart(days, weights);        
    }

    private DayRecord? SelectedRecord => dayRecords.FirstOrDefault(r => r.Date.ToString().Equals(selectedDay, StringComparison.OrdinalIgnoreCase));

    private void InitializeChart(IEnumerable<string> labels, IEnumerable<double> data)
    {
        _config = new BitChartLineConfig
        {
            Options = new BitChartLineOptions
            {
                Responsive = true,
                Title = new BitChartOptionsTitle
                {
                    Display = true,
                    Text = "Weight vs Time"
                },
                Tooltips = new BitChartTooltips
                {
                    Mode = BitChartInteractionMode.Nearest,
                    Intersect = true
                },
                Hover = new BitChartHover
                {
                    Mode = BitChartInteractionMode.Nearest,
                    Intersect = true
                },
                Scales = new BitChartScales
                {
                    XAxes =
            [
                new BitChartCategoryAxis
                        {
                            ScaleLabel = new BitChartScaleLabel
                            {
                                LabelString = "Day"
                            },
                            GridLines = new BitChartGridLines
                            {
                                Color = "gray"
                            }
                        }
            ],
                    YAxes =
            [
                new BitChartLinearCartesianAxis
                        {
                            ScaleLabel = new BitChartScaleLabel
                            {
                                LabelString = "Weight (Lbs)"
                            },
                            GridLines = new BitChartGridLines
                            {
                                Color = "gray"
                            }
                        }
            ]
                }
            }
        };

        IDataset<double> dataset = new BitChartLineDataset<double>(data)
        {
            Label = "Me",
            BackgroundColor = BitChartColorUtil.FromDrawingColor(System.Drawing.Color.FromArgb(54, 162, 235)),
            BorderColor = BitChartColorUtil.FromDrawingColor(System.Drawing.Color.FromArgb(54, 162, 235)),
            Fill = BitChartFillingMode.Disabled
        };

        _config.Data.Labels.AddRange(labels);
        _config.Data.Datasets.Add(dataset);
    }
}