@page "/"

@using DietAndExercise.Models
@using System.Collections.ObjectModel

@inject DietAndExercise.Services.IDietAndExerciseService DietAndExerciseService

@layout AlternateLayout

<PageTitle>Home</PageTitle>

@if (dayRecords == null || !System.Linq.Enumerable.Any(dayRecords))
{
    <p>No records found.</p>
}
else
{
    <div><div>Max: @max</div><div>Min: @min</div></div>
    <BitChart Config="_config" @ref="_chart" />
    <div class="record-list">
        @foreach (var record in dayRecords)
        {
            <div class="card mb-2">
                <div class="card-body">
                    <pre style="margin:0;">
                        @System.Text.Json.JsonSerializer.Serialize(record, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })
                                            </pre>
                </div>
            </div>
        }
    </div>
}

@code {
    IEnumerable<DayRecord> dayRecords = System.Array.Empty<DayRecord>();
    double max;
    double min;
    private const int INITAL_COUNT = 5;

    private BitChart _chart = default!;
    private BitChartLineConfig _config = default!;
    protected override void OnInitialized()
    {
        dayRecords = DietAndExerciseService.GetHistory();
        max = dayRecords.Max(dr => dr.WeightLb);
        min = dayRecords.Min(dr => dr.WeightLb);

		_config = new BitChartLineConfig
		{
			Options = new BitChartLineOptions
			{
				Responsive = true,
				Title = new BitChartOptionsTitle
				{
					Display = true,
					Text = "BitChart Line Chart"
				},
				Tooltips = new BitChartTooltips
				{
					Mode = BitChartInteractionMode.Nearest,
					Intersect = true
				},
				Hover = new BitChartHover
				{
					Mode = BitChartInteractionMode.Nearest,
					Intersect = true
				},
				Scales = new BitChartScales
				{
					XAxes =
					[
						new BitChartCategoryAxis
						{
							ScaleLabel = new BitChartScaleLabel
							{
								LabelString = "Month"
							},
							GridLines = new BitChartGridLines
							{
								Color = "gray"
							}
						}
					],
					YAxes =
					[
						new BitChartLinearCartesianAxis
						{
							ScaleLabel = new BitChartScaleLabel
							{
								LabelString = "Value"
							},
							GridLines = new BitChartGridLines
							{
								Color = "gray"
							}
						}
					]
				}
			}
		};

		IDataset<int> dataset1 = new BitChartLineDataset<int>(BitChartDemoUtils.RandomScalingFactor(INITAL_COUNT))
		{
			Label = "My first dataset",
			BackgroundColor = BitChartColorUtil.FromDrawingColor(BitChartDemoColors.Red),
			BorderColor = BitChartColorUtil.FromDrawingColor(BitChartDemoColors.Red),
			Fill = BitChartFillingMode.Disabled
		};

		IDataset<int> dataset2 = new BitChartLineDataset<int>(BitChartDemoUtils.RandomScalingFactor(INITAL_COUNT))
		{
			Label = "My second dataset",
			BackgroundColor = BitChartColorUtil.FromDrawingColor(BitChartDemoColors.Blue),
			BorderColor = BitChartColorUtil.FromDrawingColor(BitChartDemoColors.Blue),
			Fill = BitChartFillingMode.Disabled
		};

		_config.Data.Labels.AddRange(BitChartDemoUtils.Months.Take(INITAL_COUNT));
		_config.Data.Datasets.Add(dataset1);
		_config.Data.Datasets.Add(dataset2);
    }

	public static class BitChartDemoColors
	{
		private static readonly Lazy<IReadOnlyList<System.Drawing.Color>> _all = new(() =>
		[
			Red, Orange, Yellow, Green, Blue, Purple, Grey
		]);

		public static IReadOnlyList<System.Drawing.Color> All => _all.Value;

		public static readonly System.Drawing.Color Red = System.Drawing.Color.FromArgb(255, 99, 132);
		public static readonly System.Drawing.Color Orange = System.Drawing.Color.FromArgb(255, 159, 64);
		public static readonly System.Drawing.Color Yellow = System.Drawing.Color.FromArgb(255, 205, 86);
		public static readonly System.Drawing.Color Green = System.Drawing.Color.FromArgb(75, 192, 192);
		public static readonly System.Drawing.Color Blue = System.Drawing.Color.FromArgb(54, 162, 235);
		public static readonly System.Drawing.Color Purple = System.Drawing.Color.FromArgb(153, 102, 255);
		public static readonly System.Drawing.Color Grey = System.Drawing.Color.FromArgb(201, 203, 207);
	}

	public static class BitChartDemoUtils
	{
		public static readonly Random _rng = new();

		public static IReadOnlyList<string> Months { get; } = new ReadOnlyCollection<string>(
		[
			"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
		]);

		private static int RandomScalingFactorThreadUnsafe(int min, int max) => _rng.Next(min, max);

		public static int RandomScalingFactor()
		{
			lock (_rng)
			{
				return RandomScalingFactorThreadUnsafe(0, 100);
			}
		}

		public static IEnumerable<int> RandomScalingFactor(int count, int min = 0, int max = 100)
		{
			int[] factors = new int[count];
			lock (_rng)
			{
				for (int i = 0; i < count; i++)
				{
					factors[i] = RandomScalingFactorThreadUnsafe(min, max);
				}
			}

			return factors;
		}

		public static IEnumerable<DateTime> GetNextDays(int count)
		{
			DateTime now = DateTime.Now;
			DateTime[] factors = new DateTime[count];
			for (int i = 0; i < factors.Length; i++)
			{
				factors[i] = now.AddDays(i);
			}

			return factors;
		}
	}
}